(function(Q){Q.ImageCropper=function(E,R,J){function F(a){K();x.show();x.addClass("notransition");l.addClass("notransition");x[0].offsetHeight;l[0].offsetHeight;x.removeClass("notransition");l.removeClass("notransition");x.addClass("icrop-transition");l.addClass("icrop-transition");a?C.setVals(a.x,a.y,a.w,a.h):C.setVals(0,0,l.width(),l.height());clearTimeout(L);L=setTimeout(function(){x.removeClass("icrop-transition");l.removeClass("icrop-transition")},1E3)}function G(){var a=Math.min(R,z.width());
if(t/u>a/J)var b=a/t*u;else b=J,a=b/u*t;v.css({width:a,height:b});l.css({width:a,height:b});v[0].width=t;v[0].height=u;l[0].width=t;l[0].height=u;M(v[0],N,h,m);M(l[0],S,h,m);K()}function M(a,b,c,d){b.clearRect(0,0,a.width,a.height);b.translate(a.width/2,a.height/2);var e=90===d||270===d;b.scale(A&&!e||B&&e?-1:1,B&&!e||A&&e?-1:1);0<d?(b.rotate(d/180*Math.PI),180===d?(b.translate(-a.width/2,-a.height/2),b.drawImage(c,0,0,a.width,a.height),b.translate(a.width/2,a.height/2)):(b.translate(-a.height/2,
-a.width/2),b.drawImage(c,0,0,a.height,a.width),b.translate(a.height/2,a.width/2)),b.rotate(-d/180*Math.PI)):b.drawImage(c,-a.width/2,-a.height/2,a.width,a.height);b.scale(1,1);b.translate(-a.width/2,-a.height/2)}function K(){T.height(v.height()).width(v.width())}function w(a,b,c,d){b=b*d+c;return{r:a[4*b],g:a[4*b+1],b:a[4*b+2],a:a[4*b+3]}}function D(a,b){return(a.r-b.r)*(a.r-b.r)+(a.g-b.g)*(a.g-b.g)+(a.b-b.b)*(a.b-b.b)+(a.a-b.a)*(a.a-b.a)}E=$(E);var z=$('<div class="icrop-wrap"><canvas class="icrop-preview-canv"></canvas><div class="icrop-bg"></div><div class="icrop-box"><div class="icrop-clip-wrap"><canvas class="icrop-clip-canv"></canvas></div></div></div>'),
x=z.find(".icrop-box"),T=z.find(".icrop-bg"),v=z.find(".icrop-preview-canv"),l=z.find(".icrop-clip-canv");E.html(z);var H,k=this,t,u,m=0,B=!1,A=!1,h=new Image,O="",I=0,P="",C=new Dragger(x,l,function(a,b,c,d){a=parseInt(a);b=parseInt(b);l.css({left:-a,top:-b});H&&H()}),N=v[0].getContext("2d"),S=l[0].getContext("2d");k.getFilename=function(){return O};k.getTemplateId=function(){return I};k.setTemplateId=function(a){I=~~a};k.getOriginalImg=function(){return h};k.getOriginalUrl=function(){return P};
k.setMoveCallback=function(a){H=a};k.setSrc=function(a,b,c,d){m=0;A=B=!1;$(h).off("load").on("load",function(){t=h.naturalWidth;u=h.naturalHeight;G();F()});h.src=a;O=b;I=~~c;P=d||""};k.getFinalDataUrl=function(a,b,c,d){var e=k.getVals();e=0!==e.x||0!==e.y||e.w!==h.naturalWidth||e.h!==h.naturalHeight||0!==m||B||A?!0:!1;if(!e&&"data:"===h.src.substr(0,5)&&!c)return h.src;c=k.getVals();e=d?c.w*d:c.w;d=d?c.h*d:c.h;var g=$("<canvas>").attr({width:e,height:d});g[0].getContext("2d").drawImage(v[0],c.x,c.y,
c.w,c.h,0,0,e,d);return b?g[0].toDataURL(a,b):g[0].toDataURL(a)};k.setVals=function(a){var b=l.width()/(90===m||270===m?h.naturalHeight:h.naturalWidth),c=l.height()/(90===m||270===m?h.naturalWidth:h.naturalHeight);F({x:a.x*b,y:a.y*c,w:a.w*b,h:a.h*c})};k.getVals=function(){var a=(90===m||270===m?h.naturalHeight:h.naturalWidth)/l.width(),b=(90===m||270===m?h.naturalWidth:h.naturalHeight)/l.height(),c=C.getVals();return{x:Math.round(c.x*a),y:Math.round(c.y*b),w:Math.round(c.w*a),h:Math.round(c.h*b)}};
k.constrainVals=function(){C.constrainVals()};k.getRotation=function(){return m};k.autoCrop=function(a){var b=k.setVals;var c=t,d=u,e=N.getImageData(0,0,c,d).data,g=[w(e,c,0,0),w(e,c,c-1,0),w(e,c,c-1,e.length/4/c-1),w(e,c,0,e.length/4/c-1)];var q={};for(var f=0;f<g.length;f++){var r=g[f].r+","+g[f].b+","+g[f].g+","+g[f].a;q[r]=q[r]?q[r]+1:1}g=0;f="";for(var p in q)q.hasOwnProperty(p)&&q[p]>g&&(g=q[p],f=p);f=f.split(",");q=f={r:f[0],g:f[1],b:f[2],a:f[3]};g=0;f=c;r=d;p=0;b:for(;p<c;p++){for(var n=g;n<
d;n++){var y=D(q,w(e,c,p,n));if(1024<y)break b}f--}g=0;b:for(;g<d;g++){for(n=p;n<c;n++)if(y=D(q,w(e,c,n,g)),1024<y)break b;r--}f;b:for(;0<f;f--)for(n=g;n<g+r;n++)if(y=D(q,w(e,c,p+f,n)),1024<y)break b;r;b:for(;0<r;r--)for(n=p;n<p+f;n++)if(y=D(q,w(e,c,n,g+r)),1024<y)break b;a=0===f||0===r?{x:0,y:0,w:c,h:d}:{x:Math.max(0,p-a),y:Math.max(0,g-a),w:Math.max(0,Math.min(c,f+2*a)),h:Math.max(0,Math.min(d,r+2*a))};b.call(k,a)};k.rotateClockwise=function(){m=270===m?0:m+90;var a=t;t=u;u=a;G();F()};k.flipHorizontal=
function(){90===m||270===m?B=!B:A=!A;G()};var L}})(window);
